pipeline {
  agent {
      label 'slave-gpu'
  }

  environment {
    WORKDIR = "docker/conda"
    INPUT = "$HOME/blazingsql/workspace_output/"
    OUTPUT = "$HOME/blazingsql/conda_output/"
  }

  parameters {
    booleanParam(name: 'PUBLISH', defaultValue: false, description: 'Publish to Anaconda Cloud')   
  }

  stages {
    stage("Repository") {
      steps {
        checkout scm
      }
    }
    
    stage("Build conda image") {
      steps {
        dir("${WORKDIR}") {
          sh "./docker_build.sh"
        }
      }
    }

    stage("Run conda image") {
      steps {
        dir("${WORKDIR}") {
          sh "./conda_build.sh ${INPUT} ${OUTPUT}"
        }
      }
    }
    
    stage("Publish") {
      when {
        expression {
          return params.PUBLISH ==~ /(?i)(Y|YES|T|TRUE|ON|RUN)/
        }
      }
      steps {
        echo "upload"
        //sh "anaconda upload /home/mario21ic/.conda/envs/generator/conda-bld/linux-64/pkg_mario21ic-4.0-py35_feature2_0.tar.bz2 --label python35"
      }
    }
  }
}
